[[appendix-coordinate-sampling, Appendix J, Coordinate Sampling]] 
[appendix]
== Coordinate Sampling

The definitions and guidance given here allow an application to compress an existing data set using coordinate sampling, while letting the creator of the compressed dataset control the accuracy of the reconstituted coordinates through the degree of subsambling and the choice of interpolation method.

Futhermore, the definitions given here allow an application to uncompress coordinate and auxiliary coordinate variables that have been compressed using coordinate sampling. The key element of this process is the reconstitution of the full resolution coordinates in the domain of the data by interpolation between the lower resolution coordinates, the tie points, stored in the compressed dataset.

=== General Definitions

The target domain is segmented into smaller interpolation zones as described in <<compression-by-coordinate-sampling-tie-points-and-interpolation-zones>>.

For one-dimensional interpolation, an interpolation zone is defined by two tie points, one at each end of the interpolation zone; for two-dimensional interpolation, an interpolation zone is defined by four tie points, one at each corner of a rectangular area aligned with the domain axes; etc. Examples of one-dimensional and two-dimensional interpolation zones are shown in <<interpolation>>.


[[interpolation, figure 1]]
[.text-center]
.Tie Points A, B, C and D, interpolation indices i, interpolation variables s and coordinate values c for one and two dimensional interpolation.
image::images/ci_interpolation.svg[,100%,pdfwidth=50vw,align="center"] 


The coordinate interpolation methods are named to indicate the number of dimensions they interpolate as well as the type of interpolation provided. For example, the interpolation method named `linear` provides linear interpolation in one dimension and the method named `bi_linear` provides linear interpolation in two dimensions. Equivalently, the interpolation method named `quadratic` provides quadratic interpolation in one dimension and the interpolation method named `bi_quadratic` provides quadratic interpolation in two dimensions.

When an interpolation method is referred to as linear or quadratic, it means that the method is linear or quadratic in the indices of the interpolation dimensions. 

For convenience, an interpolation variable `s` is introduced, calculated as a function of the index in the target domain of the coordinate value to be reconstituted. In the case of one dimensional interpolation the interpolation variable is computed as 

`s = (i - ia)/(ib - ia)`

where `ia` and `ib` are the indices in the target domain of the tie points `A` and `B` and `i` is the index in the target domain of the coordinate value to be reconstituted. 

Note that the value of `s` varies from `0.0` at the tie point `A` to `1.0` at tie point `B`. For example, if `ia = 100` and `ib = 110` and the index in the target domain of the coordinate value to be reconstituted is `i = 105`, then `s = (105 - 100)/(110 - 100) = 0.5`.

In the case of two dimensional interpolation, the two interpolation variables are equivalently computed as

`s1 = (i1 - ia1)/(ib1 - ia1)`  +
`s2 = (i2 - ia2)/(id2 - ia2)`

where `ia1` and `ib1` are the first dimension indices in the target domain of the tie points `A` and `B`, `ia2` and `id2` are the second dimension indices in the target domain of the tie points `A` and `D` and the indices `i1` and `i2` are the first and second dimension indices in the target domain of the coordinate value to be reconstituted. 

For the reconstitution of the uncompressed coordinate and auxiliary coordinate variables the interpolation method can be applied independently for each interpolation zone, making it possible to parallelize the computational process.


=== Interpolation Methods

==== Linear Interpolation

[cols="6,15"]
|===============
| Name | **`interpolation_name = "linear"`** 
| Description | General purpose one dimensional linear interpolation method 
| Interpolation Coefficient terms | None
| Interpolation Configuration terms | `coordinate_conversion` of dimension (interpolation_zone_1)
| Coordinate Compression Calculations | Calculate `coordinate_conversion`, see <<coordinate_conversion>>
| Coordinate Uncompression Calculations | 
  Calculation of interpolated coordinate `c` at `s` + 
 `c = (1 - s)*c_a + s*c_b`
|===============

==== Bilinear Interpolation 

[cols="6,15"]
|===============
| Name | **`interpolation_name = "bi_linear"`** 
| Description | General purpose two dimensional linear interpolation method 
| Interpolation Coefficient terms | None
| Interpolation Configuration terms | `coordinate_conversion` of dimension (interpolation_zone_1, interpolation_zone_2)
| Coordinate Compression Calculations | Calculate `coordinate_conversion`, see <<coordinate_conversion>>
| Coordinate Uncompression Calculations | 
  Calculation of interpolated coordinate `c` at `(s1, s2)` + 
    `c_ab = (1 - s1)*c_a + s1*c_b` +
    `c_dc = (1 - s1)*c_d + s1*c_c` +
    `c = (1 - s2)*c_ab + s2*c_dc`

|===============


==== Quadratic Interpolation

[cols="6,15"]
|===============
| Name | **`interpolation_name = "quadratic"`** 
| Description | General purpose one dimensional quadratic interpolation method 
| Interpolation Coefficient terms | 
`exp1` of dimension (interpolation_zone_1, tie_point_interpolation_1) +
`align1` of dimension (interpolation_zone_1, tie_point_interpolation_1) +
| Interpolation Configuration terms | `coordinate_conversion` of dimension (interpolation_zone_1), see <<coordinate_conversion>>
| Coordinate Compression Calculations | Calculate `coordinate_conversion`, see <<coordinate_conversion>> +
Calculate `exp1` and `align1`  TO BE WRITTEN
| Coordinate Uncompression Calculations | 
 Calculation of interpolated coordinate `c` at `s` +
    `sq = s + s * (1 - s) * exp1`  +
    `c = (1 - sq) * c_a + sq * c_b` 
|===============

==== Biquadratic Interpolation  

[cols="6,15"]
|===============
| Name | **`interpolation_name = "bi_quadratic"`** 
| Description | General purpose two dimensional quadratic interpolation method 
| Interpolation Coefficient terms | 
`exp1` of dimension (interpolation_zone_1, tie_point_interpolation_1) +
`align1` of dimension (interpolation_zone_1, tie_point_interpolation_1) +
`exp2` of dimension (tie_point_interpolation_2, interpolation_zone_2) +
`align2` of dimension (tie_point_interpolation_2, interpolation_zone_2)
| Interpolation Configuration terms | `coordinate_conversion` of dimension (interpolation_zone_1, interpolation_zone_2)
| Coordinate Compression Calculations | Calculate `coordinate_conversion`, see <<coordinate_conversion>> +
Calculate `exp1`, `align1`, `exp2` and `align2`  TO BE WRITTEN
| Coordinate Uncompression Calculations | 
  Calculation of interpolated coordinate `c` at `(s1, s2)` +
    `sq1 = s1 + s1 * (1 - s1) * exp1 + s2 * (1 - s2) * align2` +
    `sq2 = s2 + s2 * (1 - s2) * exp2 + s1 * (1 - s1) * align1` +
    `c_ab = (1 - sq1)*c_a + sq1*c_b` +
    `c_dc = (1 - sq1)*c_d + sq1*c_c` +
    `c = (1 - sq2)*c_ab + sq2*c_dc`
|===============


[[coordinate_conversion]]
=== Coordinate Conversion

 
==== Geographic Coordinates

[cols="6,15"]
|===============
| Applicable to Pairs of Coordinates with Standard Names | `(latitude, longitude)`
| Pre-Interpolation Coordinate Conversion | 
For `coordinate_conversion = xyz` use +
`x=cos⁡(latitude) * cos⁡(longitude)` +
`y=cos⁡(latitude) * sin⁡(longitude)` +
`z=sin⁡(latitude)` +
For `coordinate_conversion = xy` use +
`x=cos⁡(latitude) * cos⁡(longitude)` +
`y=cos⁡(latitude) * sin⁡(longitude)` +

| Post-Interpolation Coordinate Conversion | 
For `coordinate_conversion = xyz` use +
`longitude = atan2(y, x)` +
`latitude = atan2(z, sqrt(x * x + y * y))` +
For `coordinate_conversion = xy` use +
`longitude = atan2(y, x)` +
`latitude = sign(z) * atan(sqrt(x * x + y * y))` +

|===============
 
==== Spherical Coordinates

[cols="6,15"]
|===============
| Applicable to Pairs of Coordinates with Standard Names | 
`(sensor_azimuth_angle, sensor_zenith_angle)` +
`(solar_azimuth_angle, solar_zenith_angle)`  +
`(lunar_azimuth_angle, lunar_zenith_angle)` (TO DO: propose as standard name) +
`(platform_azimuth_angle, platform_zenith_angle)`

| Pre-Interpolation Coordinate Conversion | 
For `coordinate_conversion = xyz` use +
`x=sin⁡(zenith) * sin⁡(azimuth)` +
`y=sin⁡(zenith) * cos⁡(azimuth)` +
`z=cos⁡(zenith)` +

For `coordinate_conversion = xy` use +
`x=sin⁡(zenith) * sin⁡(azimuth)` +
`y=sin⁡(zenith) * cos⁡(azimuth)` +

| Post-Interpolation Coordinate Conversion | 
For `coordinate_conversion = xyz` use +
`azimuth = atan2(y, x)` +
`zenith = atan2(sqrt(x * x + y * y), z)` +
For `coordinate_conversion = xy` use +
`azimuth = atan2(y, x)` +
`zenith = sign(z) * atan(sqrt(x * x + y * y))` +

|===============


=== Coordinate Compression Steps


[[compression-by-coordinate-sampling-generation-of-tie-points]]
.Generation of Tie Point Variables and Interpolation Variables
[options="header",cols="1,16,6",caption="Table J.1. "]
|===============
| Step | Description | Link

| 1
| Identify the coordinate and auxillary coordinate variables for which tie point and interpolation variables are required.
| 

| 2
| Identify non-overlapping subsets of the coordinate variables to be interpolated by the same interpolation method. For each coordinate variable subset, create an interpolation variable and specify the selected interpolation method using the **`interpolation_name`** attribute of the interpolation variable. 
| <<compression-by-coordinate-sampling-interpolation-variable>>

| 3
| For each coordinate variable subset, add the coordinates variable subset and the corresponding interpolation variable to the the **`tie_points`** attribute of the data variable. 
| <<compression-by-coordinate-sampling-tie-points-attribute>>


| 4
| For each coordinate variable subset, identify the set of interpolation dimensions and the set of non-interpolation dimensions.
| <<compression-by-coordinate-sampling-dimensions>>

| 5
| For each set of the interpolation dimensions, identify the interpolation areas and select the interpolation zones and the tie points, taking into account the required coordinate reconstitution accuracy when selecting the density of tie points.
| <<compression-by-coordinate-sampling-tie-points-and-interpolation-zones>>

| 6
| For each of the interpolation dimensions, add the interpolation dimension, the corresponding tie point interpolation dimension and, if required by the selected interpolation method, its corresponding interpolation zone dimension to the **`tie_point_dimensions`** attribute of the data variable.
| <<compression-by-coordinate-sampling-tie-point-dimensions-attribute>>

| 7
| For each of the interpolation dimensions, record the location of each identified tie point in a tie point index variable. For each interpolation dimension, add the interpolation dimension and its tie point index variable to the **`tie_point_indices`** attribute of the data variable.
| <<compression-by-coordinate-sampling-tie-point-indices>>

| 8
| For each of the target coordinate and auxillary coordinate variables, create the corresponding tie point coordinate variable and copy the coordinate values from the target domain coordinate variables to the tie point variables for the target domain indices identified by the tie point index variable. Repeat this step for each combination of indices of the non-interpolation dimensions.
| <<compression-by-coordinate-sampling-tie-point-indices>>

| 9
| For each of the target coordinate and auxillary coordinate variable having a **`bounds`** attribute, add the **`bounds`** attribute to the tie point coordinate variable, create the tie point bounds variable and copy the bounds values from the target domain bounds variable to the tie point bounds variable for the target domain indices identified by the tie point index variable. Repeat this step for each combination of indices of the non-interpolation dimensions.
| <<compression-by-coordinate-sampling-bounds>>

| 10
| Finally, if required by the selected interpolation method, follow the steps defined for the method in Appendix J to create any required interpolation coefficients variables and interpolation configuration variables. As relevant, create the  **`interpolation_coefficients`** and **`interpolation_configuration`** attributes and populate them with the interpolation coefficients variables and interpolation configuration variables respectively.
| <<compression-by-coordinate-sampling-interpolation-variable>>

|===============


=== Coordinate Uncompression Steps


[[compression-by-coordinate-sampling-reconstitution-of-coordinates]]
.Reconstitution of Coordinate and Auxillary Coordinate Variables
[options="header",cols="1,16,6",caption="Table J.2. "]
|===============
| Step | Description | Link

| 1
| From the **`tie_points`** attribute of the data variable, identify the coordinate and auxillary coordinate variable subsets, for which tie point interpolation is required.
| <<compression-by-coordinate-sampling-tie-points-attribute>>

| 2
| For each coordinate variable subset, identify the set of dimensions. Using the **`tie_point_dimensions`** attribute of the data variable, identify the set of interpolation dimensions and the set of non-interpolation dimensions.
| <<compression-by-coordinate-sampling-dimensions>>

<<compression-by-coordinate-sampling-tie-point-dimensions-attribute>>

| 3
| From the **`tie_point_dimensions`** attribute of the data variable, identify for each of the interpolation dimensions the corresponding tie point interpolation dimension and, if defined, the corresponding interpolation zone dimension.
| <<compression-by-coordinate-sampling-tie-point-dimensions-attribute>>

| 4
| From the tie point index variables referenced in the **`tie_point_indices`** attribute of the data variable, identify the location of the tie points in the corresponding interpolation dimension.
| <<compression-by-coordinate-sampling-tie-point-indices>>

| 5
| For each of the interpolation dimensions, identify pairs of adjacent indices in the tie point index variable with index values differing by more than one, each index pair defining the extend of an interpolation zone in that dimension. A full interpolation zone is defined by one such index pair per interpolation dimension, with combinations of one index from each pair defining the interpolation zone tie points.
| <<compression-by-coordinate-sampling-tie-points-and-interpolation-zones>>

| 6
| From the **`tie_points`** attribute of the data variable, identify the interpolation variable for the coordinate and auxillary coordinate variable subset. From the **`interpolation_name`** attribute of the interpolation variable, identify the interpolation method. 
| <<compression-by-coordinate-sampling-interpolation-variable>>

| 7
| As required by the selected interpolation method, identify the interpolation coefficients variables and interpolation configuration variables from the interpolation variable **`interpolation_coefficients`** and **`interpolation_configuration`** attributes respectively.
| <<compression-by-coordinate-sampling-interpolation-variable>>

| 8
| For each of the tie point coordinate and auxillary coordinate variables, create the corresponding target coordinate variable. For each interpolation zone, apply the interpolation method to reconstitute the target domain coordinate values and store these in the target domain coordinate variables. Repeat this step for each combination of indices of the non-interpolation dimensions.
| <<compression-by-coordinate-sampling-tie-point-indices>>

| 9
| For each of the tie point coordinate and auxillary coordinate variables having a **`bounds`** attribute, add the **`bounds`** attribute to the target coordinate variable and create the target domain bounds variable. For each interpolation zone, apply the interpolation method to reconstitute the target domain bound values and store these in the target domain bound variables. Repeat this step for each combination of indices of the non-interpolation dimensions.
| <<compression-by-coordinate-sampling-bounds>>

| 10
| If auxiliary coordinate variables have been reconstituted, then, if not already present, add a **`coordinates`** attribute to the data variable and add to the attribute the list of the names of the reconstituted auxiliary coordinate variables.
| <<coordinate-system>>

|===============
